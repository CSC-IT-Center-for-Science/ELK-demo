---
#  - name: update all packages first
#    yum: pkg=* state=latest

  - name: add logstash repo
    template: src=templates/logstash.repo.j2 dest=/etc/yum.repos.d/logstash.repo owner=root group=root mode=0644
    register: logstashrepo
    when: ansible_os_family == "RedHat" and add_logstash_repofile == "yes"

  - name: install software from logstash repo
    yum: "pkg={{item}} state=installed"
    with_items: programs_to_install
    when: ansible_distribution_major_version == "6"

  - name: install software from logstash repo EL7
    yum: "pkg={{item}} state=installed"
    with_items: el7programs_to_install
    when: ansible_distribution_major_version == "7"

  - name: enable services on boot
    service: name={{item}} enabled=yes
    with_items: programs_on_boot

# Here we could add some templates for logstash config
# Also logstash -t (config test) can be used to verify the config.
#

  - name: add logstash prod_example config
    template: src=../logstash/config/prod_example/logstash.conf dest=/etc/logstash/conf.d/logstash.conf owner=logstash group=root mode=0644
    register: logstashconfig
    when: ansible_os_family == "RedHat" and logstash_prod_example == "yes"

  - name: add elasticsearch template
    template: src=../logstash/templates/es-template-demo.json dest=/etc/logstash/templates/es-template-demo.json owner=logstash group=root mode=0644
    register: estemplate
    when: ansible_os_family == "RedHat"

## TODO: Install template ( curl -XDELETE localhost:9199/_template/template-demo ; curl -XPUT http://localhost:9199/_template/template-demo -d @/etc/logstash/templates/es-template-demo.json )

  - name: install redis
    yum: "pkg=redis state=installed"
    when: ansible_distribution_major_version == "7" and logstash_prod_example == "yes"

  - name: add redis config
    template: src=../logstash/config/prod_example/redis.conf dest=/etc/redis.conf owner=redis group=root mode=0644
    when: ansible_os_family == "RedHat" and logstash_prod_example == "yes"
 
  - name: enable redis on boot
    service: name=redis enabled=yes state=started
    when: ansible_distribution_major_version == "7" and logstash_prod_example == "yes"

  - name: start logstash on boot
    service: name=redis state=started
    when: logstash_prod_example == "yes"

  - name: restart logstash on new config
    service: name=logstash state=restarted
    when: logstashconfig.changed
